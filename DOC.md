# Project API Documentation

> This documentation is auto-generated by `scripts/generate_doc.py`.
> It provides a reference for the project's modules, classes, and functions to assist LLMs in understanding the codebase.

## Project Structure
```
├── core
│   ├── config.py
│   ├── constants.py
│   ├── logger.py
│   └── singleton.py
├── engines
│   ├── backtest.py
│   ├── engine.py
│   ├── live.py
│   └── paper.py
├── notifier
│   ├── email.py
│   └── notifier.py
├── providers
│   ├── longport.py
│   └── provider.py
├── strategies
│   ├── composite.py
│   ├── macd.py
│   ├── rsi.py
│   ├── strategy.py
│   └── trend_swing_t.py
├── tradeflow.py
├── trading
│   ├── account.py
│   ├── persistence.py
│   └── position.py
└── utils
    ├── finance.py
    ├── formatting.py
    ├── indicators.py
    ├── market.py
    ├── plotter.py
    └── reporting.py
```

## API Reference

---

### Module: `app.tradeflow`

#### Class `TradeFlow`

- `__init__(self) -> None`

- `run(self) -> None`

---

### Module: `app.core.config`

#### Class `AppConfig`

应用程序配置管理器。
从 YAML 文件加载配置并提供访问方法。


- `__init__(self) -> None`

  初始化 AppConfig。

- `get(self, key: str, default: Any = None) -> Any`

  使用点号表示法获取配置值。
  
  Args:
                  key: 配置键（例如 'longport.app_key'）。
                  default: 如果键未找到时的默认值。
  
  Returns:
          配置值或默认值。

---

### Module: `app.core.constants`

#### Class `TradeMode(str, Enum)`

交易模式枚举


#### Class `SignalType(str, Enum)`

交易信号类型枚举


#### Class `Market(str, Enum)`

市场板块枚举


#### Class `TradeStatus(str, Enum)`

交易状态枚举


#### Class `TradeStraegy(str, Enum)`

交易策略枚举


#### Class `ProviderType(str, Enum)`

券商api枚举


#### Class `NotifierType(str, Enum)`

通知方式枚举


---

### Module: `app.core.logger`

#### Class `CustomFormatter(logging.Formatter)`

自定义日志格式化器，根据日志级别更改格式。

DEBUG 级别包含时间戳、模块名、级别和消息。
其他级别仅包含消息。


- `__init__(self) -> None`

- `format(self, record: logging.LogRecord) -> str`

#### Function `setup_logging(log_level_str: str) -> None`

初始化日志配置。

Args:
        log_level_str: 日志级别字符串。

---

### Module: `app.core.singleton`

#### Function `singleton_threadsafe(cls)`

---

### Module: `app.engines.backtest`

#### Class `BacktestEngine(Engine)`

回测执行引擎


- `__init__(self, *args, **kwargs)`

- `set_data(self, data: Dict[str, pd.DataFrame]) -> None`

  设置回测数据

- `run(self, start_time: Optional[pd.Timestamp] = None) -> Dict[str, Any]`

  运行回测

#### Class `BacktestUniversePoolBuilder`

- `__init__(self, quote_ctx: QuoteContext, max_symbols: int, one_per_industry: bool, lookback_days: int, batch_size: int) -> None`

- `build_pool(self, all_symbols: List[str], as_of: date) -> List[str]`

#### Class `BacktestDailyWorkflow`

- `__init__(self, quote_ctx: QuoteContext, engine: BacktestEngine, pool_builder: BacktestUniversePoolBuilder, symbols_universe: List[str], period: Period, warmup_days: int) -> None`

- `run(self, start_date: date, end_date: date) -> Dict[str, Any]`

#### Function `run_backtest(quote_ctx: QuoteContext, strategy: Strategy) -> Dict[str, Any]`

执行回测流程（Runner entrypoint）。

---

### Module: `app.engines.engine`

#### Class `Engine(ABC)`

策略执行引擎抽象基类，定义统一的策略执行接口。


- `__init__(self)`

- `initialize(self, symbols: List[str], quote_ctx: QuoteContext) -> bool`

  初始化引擎

- `create_account(self) -> None`

  交易账户

- `run(self) -> Dict[str, Any]`

  运行策略执行引擎

- `reset(self) -> None`

  清理资源

- `process_signal(self, symbol: str, signal: Dict[str, Any], current_time: datetime, current_price: float) -> Dict[str, Any]`

  处理单个信号

- `calculate_target_position_ratio(self, signal: Dict[str, Any]) -> float`

  根据策略因子计算目标仓位比例。

- `calculate_order_quantity(self, action: SignalType, current_position: int, price: float, total_equity: float, available_cash: float, lot_size: int = 1, signal: Optional[Dict[str, Any]] = None) -> int`

  把 BUY/SELL 信号转换为具体下单数量（支持加/减仓）。

- `record_equity(self, timestamp: datetime) -> None`

  记录当前权益

- `get_performance(self) -> Dict[str, Any]`

  获取性能指标

- `get_results(self) -> Dict[str, Any]`

  获取完整结果

---

### Module: `app.engines.live`

#### Class `LiveEngine(Engine)`

实盘执行引擎


- `__init__(self, *args, **kwargs)`

- `set_live_params(self, quote_ctx: QuoteContext, symbols: List[str], period: PeriodLike = ..., history_count: int = 100, interval: int = 60, request_delay: float = 0.5) -> None`

  设置实盘参数

- `run(self) -> Dict[str, Any]`

  运行实盘监控

#### Function `run_live_trading(quote_ctx: QuoteContext, strategy: Strategy) -> Dict[str, Any]`

执行实盘交易监控（Runner entrypoint）。

方案A：直接读 `global_config`，不再引入额外的 config/service manager 层。

---

### Module: `app.engines.paper`

#### Class `PaperEngine(Engine)`

---

### Module: `app.notifier.email`

#### Class `EmailNotifier(Notifier)`

邮件通知处理程序。
使用 SMTP 配置发送邮件。


- `__init__(self) -> None`

  使用环境变量或配置文件初始化 EmailNotifier。

- `notify(self, title: str, content: str) -> None`

  发送邮件通知。
  
  Args:
      title: 邮件主题。
      content: 邮件正文内容。

---

### Module: `app.notifier.notifier`

#### Class `Notifier(ABC)`

- `__init__(self)`

- `notify(self, title: str, content: str)`

---

### Module: `app.providers.longport`

#### Class `LongPortProvider(Provider)`

长桥API数据提供器


- `__init__(self)`

- `initialize(self, **kwargs: Any) -> bool`

  初始化长桥数据提供器

- `get_data(self, symbol: str, **kwargs: Any) -> Optional[pd.DataFrame]`

  获取单个标的的数据

- `get_multiple_data(self, symbols: List[str], **kwargs: Any) -> Dict[str, pd.DataFrame]`

  批量获取多个标的的数据

- `get_stock_names(self, symbols: List[str]) -> Dict[str, str]`

  获取股票名称

- `get_stock_lot_sizes(self, symbols: List[str]) -> Dict[str, int]`

  获取股票最小交易单位

- `get_benchmark_returns(self, start_date: date, end_date: date) -> Dict[str, float]`

  获取基准收益率

---

### Module: `app.providers.provider`

#### Class `Provider(ABC)`

券商API 抽象基类，定义统一的数据访问接口。


- `__init__(self)`

- `pull_stack_list(self) -> bool`

  拉取数据

- `get_data(self, symbol: str, **kwargs: Any) -> Optional[pd.DataFrame]`

  获取指定标的的数据

- `get_multiple_data(self, symbols: List[str], **kwargs: Any) -> Dict[str, pd.DataFrame]`

  批量获取多个标的的数据

- `get_stock_names(self, symbols: List[str]) -> Dict[str, str]`

  获取股票名称

- `get_stock_lot_sizes(self, symbols: List[str]) -> Dict[str, int]`

  获取股票最小交易单位

- `get_benchmark_returns(self, start_date: date, end_date: date) -> Dict[str, float]`

  获取基准收益率

- `get_universe_symbols(self, market: str, **kwargs: Any) -> List[Dict[str, Any]]`

  获取指定市场的标的清单

---

### Module: `app.strategies.composite`

#### Class `CompositeStrategy(Strategy)`

组合策略，结合多个子策略。


- `__init__(self, strategies: List[Strategy], mode: str = 'consensus', name: Optional[str] = None, description: str = '') -> None`

  初始化组合策略。
  
  Args:
      strategies: 策略实例列表。
      mode: 决策模式。
            'consensus': 所有策略必须一致。
            'any': 任意策略触发信号（卖出优先）。
            'vote': 多数投票。
      name: 策略名称，默认使用类名
      description: 策略描述

- `analyze(self, symbol: str, df: pd.DataFrame) -> Dict[str, Any]`

  使用多个策略分析数据并合并结果。

- `add_strategy(self, strategy: Strategy) -> None`

  添加子策略到组合中。
  
  Args:
      strategy: 要添加的策略实例

- `remove_strategy(self, strategy_name: str) -> bool`

  从组合中移除指定名称的子策略。
  
  Args:
      strategy_name: 要移除的策略名称
  
  Returns:
      bool: 是否成功移除

- `get_info(self) -> Dict[str, Any]`

  获取组合策略的详细信息

---

### Module: `app.strategies.macd`

#### Class `MACDStrategy(Strategy)`

移动平均收敛散度 (MACD) 策略。


- `__init__(self, fast: int = 12, slow: int = 26, signal: int = 9) -> None`

  初始化 MACD 策略。
  
  Args:
      fast: 快速 EMA 周期。
      slow: 慢速 EMA 周期。
      signal: 信号线 EMA 周期。

- `analyze(self, symbol: str, df: pd.DataFrame) -> Dict[str, Any]`

  使用 MACD 策略分析数据。
  
  金叉: DIF 上穿 DEA -> 买入
  死叉: DIF 下穿 DEA -> 卖出

- `get_info(self) -> Dict[str, Any]`

  获取MACD策略的详细信息

---

### Module: `app.strategies.rsi`

#### Class `RSIStrategy(Strategy)`

相对强弱指数 (RSI) 策略。


- `__init__(self, period: int = 14, overbought: int = 70, oversold: int = 30) -> None`

  初始化 RSI 策略。
  
  Args:
      period: RSI 计算周期。
      overbought: 超买阈值。
      oversold: 超卖阈值。

- `analyze(self, symbol: str, df: pd.DataFrame) -> Dict[str, Any]`

  使用 RSI 策略分析数据。
  
  超卖: RSI < 超卖阈值 -> 买入
  超买: RSI > 超买阈值 -> 卖出

- `get_info(self) -> Dict[str, Any]`

  获取RSI策略的详细信息

---

### Module: `app.strategies.strategy`

#### Class `Strategy(ABC)`

所有交易策略的抽象基类。
提供统一的策略接口和生命周期管理。


- `__init__(self, name: Optional[str] = None, description: str = '') -> None`

  初始化策略。
  
  Args:
      name: 策略名称，如果为None则使用类名
      description: 策略描述

- `initialize(self, **kwargs: Any) -> bool`

  初始化策略，在第一次分析前调用。
  
  Args:
      **kwargs: 初始化参数
  
  Returns:
      bool: 初始化是否成功

- `analyze(self, symbol: str, df: pd.DataFrame) -> Dict[str, Any]`

  分析市场数据并生成交易信号。
  
  Args:
      symbol: 股票代码（例如 '700.HK'）。
      df: 包含至少 'close' 列的 K 线数据 DataFrame。
  
  Returns:
      包含信号的字典:
      {
          'action': 'BUY' | 'SELL' | 'HOLD',
          'price': float,
          'reason': str,
          'factors': Dict[str, Any]  # 可选：策略因子值
      }

- `analyze_with_initialization(self, symbol: str, df: pd.DataFrame, **init_kwargs: Any) -> Dict[str, Any]`

  带初始化的分析方法，确保策略在使用前已初始化。
  
  Args:
      symbol: 股票代码
      df: K线数据DataFrame
      **init_kwargs: 初始化参数
  
  Returns:
      交易信号字典

- `get_info(self) -> Dict[str, Any]`

  获取策略信息。
  
  Returns:
      策略信息字典

- `validate_data(self, df: pd.DataFrame, required_columns: Optional[list[str]] = None) -> bool`

  验证输入数据的有效性。
  
  Args:
      df: 待验证的DataFrame
      required_columns: 必需的数据列，默认为['close']
  
  Returns:
      bool: 数据是否有效

- `cleanup(self) -> None`

  清理策略资源，在策略不再使用时调用。

---

### Module: `app.strategies.trend_swing_t`

#### Class `TrendSwingConfig`

偏波段的趋势突破策略参数。

说明：默认值仅作为兜底，建议在 `config/config.yaml` 的
`strategy.params` 下配置，便于回测与实盘保持一致。


#### Class `TrendSwingTStrategy(Strategy)`

趋势突破 + ATR 风控 + 目标仓位管理 + 低频做T（可选）。


- `__init__(self, config: Optional[TrendSwingConfig] = None, **kwargs: Any) -> None`

- `analyze(self, symbol: str, df: pd.DataFrame) -> Dict[str, Any]`

  分析市场数据并生成交易信号

- `get_info(self) -> Dict[str, Any]`

  获取趋势摆动策略的详细信息

---

### Module: `app.trading.account`

#### Class `Account(ABC)`

交易账户，专注于资金和持仓管理。

职责边界：
- 管理现金余额和持仓
- 计算权益和收益
- 记录交易历史
- 不包含交易决策逻辑


- `__init__(self, initial_capital: float = 100000.0, commission_rate: float = 0.0003, on_trade: Optional[Callable] = None)`

- `set_stock_names(self, names: Dict[str, str]) -> None`

  设置股票名称映射

- `update_price(self, symbol: str, price: float) -> None`

  更新股票最新价格

- `get_total_equity(self) -> float`

  计算当前总权益（现金 + 持仓市值）

- `get_position_value(self, symbol: str) -> float`

  获取指定股票的持仓市值

- `get_position_ratio(self, symbol: str) -> float`

  获取指定股票的仓位比例

- `record_equity(self, timestamp: datetime, equity: Optional[float] = None) -> None`

  记录当前权益。
  策略：每天只保留最后一条记录。

- `get_trade_stats(self) -> Dict[str, Any]`

  计算交易统计信息，包括胜率等。
  
  统计口径：以"平仓"为一次交易（卖出后 `position_after==0`）。

- `buy(self, symbol: str, price: float, quantity: int, time: datetime, reason: str, signal_id: Optional[str] = None, factors: Optional[Dict[str, Any]] = None, trade_tag: Optional[str] = None) -> bool`

  执行买入操作（纯资金和持仓管理）。
  
  Args:
      symbol: 股票代码
      price: 买入价格
      quantity: 买入数量
      time: 交易时间
      reason: 买入原因
      signal_id: 信号ID（可选）
      factors: 策略因子（可选）
      trade_tag: 交易标签（可选）
  
  Returns:
      是否成功买入

- `sell(self, symbol: str, price: float, quantity: int, time: datetime, reason: str, signal_id: Optional[str] = None, factors: Optional[Dict[str, Any]] = None, trade_tag: Optional[str] = None) -> bool`

  执行卖出操作（纯资金和持仓管理）。
  
  Args:
      symbol: 股票代码
      price: 卖出价格
      quantity: 卖出数量
      time: 交易时间
      reason: 卖出原因
      signal_id: 信号ID（可选）
      factors: 策略因子（可选）
      trade_tag: 交易标签（可选）
  
  Returns:
      是否成功卖出

- `clear_trades(self) -> None`

  清空交易记录

- `get_account_summary(self) -> Dict[str, Any]`

  获取账户摘要信息

- `is_signal_processed(self, signal_id: str) -> bool`

  检查信号是否已处理

- `mark_signal_processed(self, signal_id: str) -> None`

  标记信号为已处理

- `clear_processed_signals(self) -> None`

  清空已处理的信号记录

---

### Module: `app.trading.persistence`

#### Class `AccountPersistence`

负责 PaperAccount 的持久化（加载和保存）。


- `__init__(self, file_path: str)`

- `load(self, account: Account) -> bool`

  从文件加载账户状态到 account 对象中。

- `save(self, account: Account) -> None`

  将 account 对象的状态保存到文件。

---

### Module: `app.trading.position`

---

### Module: `app.utils.finance`

#### Function `calculate_interval_return(start_price: float, end_price: float) -> float`

计算区间收益率。

Args:
    start_price: 起始价格
    end_price: 结束价格

Returns:
    float: 收益率百分比，如果起始价格 <= 0 则返回 0.0

#### Function `get_price_range(df: pd.DataFrame) -> tuple[float, float]`

从 DataFrame 获取起止价格。
假设 DataFrame 包含 'open' 和 'close' 列，且按时间排序。

Returns:
    tuple[float, float]: (start_price, end_price)

---

### Module: `app.utils.formatting`

#### Function `get_display_width(s: str) -> int`

计算字符串的显示宽度（东亚宽度）。

#### Function `pad_string(s: str, width: int, align: str = '<') -> str`

用空格填充字符串以达到目标显示宽度。
align: '<' 左对齐 (默认), '>' 右对齐

---

### Module: `app.utils.indicators`

#### Function `calculate_sma(df: pd.DataFrame, period: int = 20, column: str = 'close', out_col: str = 'sma') -> pd.DataFrame`

计算简单移动平均（SMA）。

#### Function `calculate_ema(df: pd.DataFrame, period: int = 20, column: str = 'close', out_col: str = 'ema') -> pd.DataFrame`

计算指数移动平均（EMA）。

#### Function `calculate_atr(df: pd.DataFrame, period: int = 14, out_col: str = 'atr') -> pd.DataFrame`

计算平均真实波幅（ATR）。要求 df 至少包含 high/low/close。

#### Function `calculate_donchian_channel(df: pd.DataFrame, period: int = 20, high_col: str = 'high', low_col: str = 'low', out_high: str = 'donchian_high', out_low: str = 'donchian_low', out_mid: str = 'donchian_mid') -> pd.DataFrame`

计算 Donchian 通道（常用于趋势突破策略）。

#### Function `calculate_adx(df: pd.DataFrame, period: int = 14, out_adx: str = 'adx', out_plus_di: str = 'plus_di', out_minus_di: str = 'minus_di') -> pd.DataFrame`

计算 ADX（趋势强度）。要求 df 至少包含 high/low/close。

#### Function `calculate_macd(df: pd.DataFrame, fast: int = 12, slow: int = 26, signal: int = 9, column: str = 'close') -> pd.DataFrame`

计算 MACD 指标。

Args:
    df: 包含价格数据的 DataFrame。
    fast: 快速 EMA 周期。
    slow: 慢速 EMA 周期。
    signal: 信号线 EMA 周期。
    column: 用于计算的价格列名。

Returns:
    添加了 'dif', 'dea', 和 'macd' 列的 DataFrame。

#### Function `calculate_rsi(df: pd.DataFrame, period: int = 14, column: str = 'close') -> pd.DataFrame`

计算 RSI 指标。

Args:
    df: 包含价格数据的 DataFrame。
    period: RSI 计算周期。
    column: 用于计算的价格列名。

Returns:
    添加了 'rsi' 列的 DataFrame。

#### Function `calculate_bollinger_bands(df: pd.DataFrame, period: int = 20, std_dev: int = 2, column: str = 'close') -> pd.DataFrame`

计算布林带指标。

Args:
    df: 包含价格数据的 DataFrame。
    period: 移动平均周期。
    std_dev: 标准差倍数。
    column: 用于计算的价格列名。

Returns:
    添加了 'upper', 'middle', 'lower' 列的 DataFrame。

---

### Module: `app.utils.market`

#### Function `get_market_symbols(force_update: bool = False) -> pd.DataFrame`

获取全市场标的（A股 + 港股通），支持本地缓存和定期更新。

---

### Module: `app.utils.plotter`

#### Function `create_performance_chart(equity_curve: List[Dict[str, Any]], trades: List[Dict[str, Any]], benchmark_data: Dict[str, pd.DataFrame], config: Dict[str, Any], output_dir: str = 'reports', filename: str = 'performance.html') -> str`

创建账户收益率与基准对比的交互式图表。

Args:
    equity_curve: 账户权益曲线列表，每项包含 'time' 和 'equity'。
    trades: 交易记录列表。
    benchmark_data: 基准数据字典，键为 symbol，值为包含 'close' 的 DataFrame。
    config: 绘图配置字典。
    output_dir: 输出目录。
    filename: 输出文件名。

Returns:
    生成的 HTML 文件路径。

---

### Module: `app.utils.reporting`

#### Function `print_backtest_summary(results: Dict[str, Any], start_date: date, end_date: date, initial_balance: float, benchmark_returns: Optional[Dict[str, float]] = None) -> None`

打印回测摘要表格。

Args:
    results: 回测结果字典。
    start_date: 回测开始日期。
    end_date: 回测结束日期。
    initial_balance: 初始资金。
    benchmark_returns: 基准收益字典。